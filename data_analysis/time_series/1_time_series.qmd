---
title: Time Series (Part I)
tools: SQL, R, RStudio, Quarto, Git/Github
description: |
  Analyzing time series data and looking for trends.
author: "Cozmina Secula"
date: "2024-07-03"
categories: [time series, trends, data analysis, data visualization]
---

<br>

The examples below of the time series analyses are inspired from the book [SQL for Data Analysis: Advanced Techniques for Transforming Data into Insights](https://www.amazon.com/SQL-Data-Analysis-Techniques-Transforming/dp/1492088781) and use the Retail and Food Services Sales data from this [source](https://github.com/cathytanimura/sql_book/tree/master/Chapter%203:%20Time%20Series%20Analysis). The data source, [Monthly Retail Trade Report: Retail and Food Services Sales](https://www.census.gov/retail/index.html#mrts), includes monthly total sales and sales for different subcategories of retail sales from 1992 to 2020. It is an Excel file that I imported into Postgres.

The purpose of these examples is to practice analyzing time series data and looking for trends. I will use SQL to arrange the data into the required result set. Then, I will graph the time series by month and year to understand the trends. I will compare the sales of two subcategories from the dataset: sales at new car dealers and sales at used car dealers, across the same time range.

#### Prerequisites

```{r}
#| label: load-packages
#| echo: true
#| warning: false
#| message: false

library(DBI)
library(dplyr)
library(tidyverse)
library(DT)
library(patchwork)

```

#### Connect to the database

```{r}
con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = 'training_center', 
                 host = 'localhost', 
                 port = 5432, 
                 user = 'postgres',
                 password = 'postgres',
                 bigint = "integer") # change integer64 to integer
```

The fields used from the dataset for analysis are: 

- `sales_month`(month and year)
- `kind_of_business`(details of subcategories of retail sales) 
- `sales` (sales figures in millions of US dollars).

### Subcategories of retail sales 

```{r}
rs_subcategories <- "
SELECT DISTINCT
    rs.kind_of_business 
FROM training_data.retail_sales rs 
ORDER BY rs.kind_of_business ;
"
rs_subcategories_tbl <- (dbGetQuery(con, rs_subcategories))

```

```{r}
#| fig-cap: Subcategories of retail sales dataset
#| echo: false

datatable(rs_subcategories_tbl, options = list(pageLength = 5, scrollY = TRUE))
```

## Total retail and food services in US

I will start by looking at the total monthly retail and food services.

### Monthly `Retail and Food Services` in US

```{r}
monthly_rfs_sales <- "
SELECT 
    rs.sales_month ,
    rs.sales 
FROM training_data.retail_sales rs 
WHERE upper(rs.kind_of_business) = upper('retail and food services sales, total');
"
monthly_rfs_sales_tbl <- (dbGetQuery(con, monthly_rfs_sales))
```

```{r}
#| echo: true
#| code-fold: true
#| fig-width: 7.5
#| fig-height: 6

(monthly_rfs_sales_plot <- ggplot(monthly_rfs_sales_tbl, aes(x = sales_month, y = sales))+
  geom_line(color = '#414040', linewidth = 0.5)+
  geom_smooth(color = '#174A7E')+
  scale_y_continuous(labels = scales::dollar_format())+
  scale_x_date(date_breaks = '5 years',
               labels = scales::date_format("%b-%y"))+
  labs(
    title = 'Monthly Retail and Food Services Sales in US',
    subtitle = '1992 to 2020',
    x = '',
    y = 'Millions of Dollars'
  )+
  theme_minimal())



```

The data has some patterns but is not so clear at monthly level.

### How do the `retail and food services` sales look by year?

```{r}
yearly_rfs_sales <- "
SELECT 
    date_part('year', rs.sales_month) AS year,
    sum(rs.sales) AS sales
FROM training_data.retail_sales rs 
WHERE upper(rs.kind_of_business) = upper('retail and food services sales, total')
GROUP BY date_part('year', rs.sales_month);
"
yearly_rfs_sales_tbl <- (dbGetQuery(con, yearly_rfs_sales))

```

```{r}
#| fig-cap: Yearly Retail and Food Services Sales 
#| echo: false

datatable(yearly_rfs_sales_tbl, options = list(pageLength = 5, scrollY = TRUE))
```

```{r}
#| echo: true
#| code-fold: true
#| fig-width: 7.5
#| fig-height: 6

yearly_rfs_sales_tbl <- yearly_rfs_sales_tbl %>%
  mutate(year = as.Date(paste0(year, "-01-01")))

# annotation data
annotations <- data.frame(
  x = as.Date(c("2009-01-01","2019-01-01")),
  y = c(4064476, 6224399),
  label = c("Financial \n crisis", "COVID-19\npandemic"),
  color = c('#800000', '#800000'),
  vjust = c(1,0.5),
  hjust = c(0.5,1 ))


(yearly_rfs_sales_plot <- ggplot(yearly_rfs_sales_tbl, aes(x = year, y = sales))+
  geom_line(color = '#414040', linewidth = 0.5)+
  scale_y_continuous(labels = scales::dollar_format())+
  scale_x_date(date_breaks = '5 years',
               labels = scales::date_format("%Y"))+
  labs(
    title = 'Yearly Retail and Food Services Sales in US (1992 to 2020)',
    subtitle = 'After increasing over time, sales dropped in 2009 but then increased again  \nover the next ten years. In 2020, sales were flat compared to 2019.',
    x = '',
    y = 'Millions of Dollars'
  )+
  theme_minimal())+
  geom_text(data = annotations, aes(x = x, y = y, label = label, color = I(color), vjust = vjust, hjust = hjust))



```

For the next analyses, I will look at sales at `new and used car dealers`, two of the subcategories included in the retail sales dataset.

## Comparing `New Car Dealers` with `Used car dealer` yearly sales

```{r}

new_used_car_sales <- "
SELECT 
    EXTRACT(YEAR FROM rs.sales_month) AS year,
    rs.kind_of_business,
    sum(rs.sales) as sales
FROM training_data.retail_sales rs 
WHERE upper(rs.kind_of_business) = upper('new car dealers') OR 
      upper(rs.kind_of_business) = upper('used car dealers')
GROUP BY EXTRACT(YEAR FROM rs.sales_month), rs.kind_of_business
ORDER BY year;
"
new_used_car_sales_tbl <- (dbGetQuery(con, new_used_car_sales))

```

```{r}
#| fig-cap: New and Used Car Yearly Sales 
#| echo: false

datatable(new_used_car_sales_tbl, options = list(pageLength = 5, scrollY = TRUE))
```

```{r}
#| echo: true
#| code-fold: true
#| fig-width: 9.5
#| fig-height: 7

new_used_car_sales_tbl <- new_used_car_sales_tbl |>
  mutate(year = as.Date(paste0(year, "-01-01")))

(new_used_car_sales_tbl_plot <- ggplot(new_used_car_sales_tbl, aes(x = year, y = sales, color = kind_of_business))+
  geom_line(linewidth = 1)+
  scale_y_continuous(labels = scales::dollar_format())+
  scale_x_date(date_breaks = "5 years",
               label= scales::date_format("%Y"))+
  labs(
    title = 'Yearly New and Used Car Deales Sales in US (1992 to 2020)',
    subtitle = 'Sales at new car dealers started higher and grew faster than sales at used car dealers. \nNew and used car sales dropped during the financial crisis but increased again \nin the following years. Sales of new cars began to decline during the COVID-19 pandemic.',
    x = '',
    y = 'Milions od Dollars',
  )+
  theme_minimal()+
  annotate(
    'rect',
    xmin = as.Date(c("2008-01-01", "2019-01-01")),
    xmax = as.Date(c("2010-01-01", "2020-01-01")),
    ymin = c(0, 0),
    ymax = c(750000,950000),
    fill = '#A6A6A5',
    alpha = 0.1
  )+
    annotate(
      'text',
      x = as.Date(c("2008-01-01", "2019-01-01")),
      y = c(460000, 950000),
      label = c("2008–2010 \nautomotive industry crisis \nas part of the \n2007–2008 financial crisis",
                "COVID-19 pandemic"),
      size = c(3.5, 3.5),
      hjust = c(0, 0),
      vjust = c(1, 0)
    )+
  theme(legend.position = "top", legend.title = element_blank(), legend.justification = 0)+
  scale_color_manual(values = c('New car dealers' = '#929497', 'Used car dealers' = '#174A7E' ))
)

```

## What were the trends in `new and used car` dealer sales percentages?

```{r}
new_and_used_car_sales_percent <- "
SELECT
    rs.sales_month,
    rs.kind_of_business,
    sum(rs.sales) AS category_sales,
    sum(sum(rs.sales)) OVER (PARTITION BY rs.sales_month) AS total_sales,
    round(sum(rs.sales) / sum(sum(rs.sales)) OVER (PARTITION BY rs.sales_month) * 100, 2) AS category_percent
FROM training_data.retail_sales rs 
WHERE rs.kind_of_business IN ('New car dealers', 'Used car dealers')
GROUP BY rs.sales_month, rs.kind_of_business
ORDER BY rs.sales_month;;
"
new_and_used_car_sales_percent_tbl <- (dbGetQuery(con, new_and_used_car_sales_percent))
```

```{r}
#| echo: false

datatable(new_and_used_car_sales_percent_tbl, options = list(pageLength = 5, scrollY = TRUE))
```

```{r}
#| echo: true
#| code-fold: true
#| fig-width: 7.5
#| fig-height: 6


(new_and_used_car_sales_percent_plot <- ggplot(new_and_used_car_sales_percent_tbl, aes(x = sales_month, y = category_percent, color = kind_of_business ))+
  geom_line(linewidth = 1)+
  scale_x_date(date_breaks = "2 years",
               labels = scales::date_format("%Y"))+
  scale_y_continuous(labels = scales::percent_format(scale = 1))+
  scale_color_manual(values = c('New car dealers' = '#929497', 'Used car dealers' = '#174A7E'))+
  theme_minimal()+
  labs(
    title = 'New and used car dealers sales as percent of monthly total in the US (1992 to 2020)',
    subtitle = 'From 2004 to 2011, new car dealer sales have gradually decreased \nand used car dealer sales have increased as a percentage of total sales. \nAfter 2011, the percentages of the two categories did not change significantly.',
    x = 'Sales Month',
    y = 'Percent'
  )+
   theme(legend.position = "top", legend.title = element_blank(), legend.justification = 0))

```

## During the past few decades, how have sales of `new and used cars` varied in dollars and percent?

```{r}
gap_percent_sales_cars <- "
WITH car_sales AS 
	(SELECT 
	    EXTRACT (YEAR FROM rs.sales_month) AS year,
	    sum(CASE WHEN upper(rs.kind_of_business) = upper('New car dealers') THEN rs.sales END) AS new_car_sales,
	    sum(CASE WHEN upper(rs.kind_of_business) = upper('Used car dealers') THEN rs.sales END) AS used_car_sales
	FROM training_data.retail_sales rs
	GROUP BY EXTRACT (YEAR FROM rs.sales_month)
	ORDER BY year)
SELECT 
    cs.year,
    cs.new_car_sales,
    cs.used_car_sales,
    (cs.new_car_sales - cs.used_car_sales) AS delta,
    round((cs.new_car_sales / cs.used_car_sales), 2) AS ratio,
    round(((cs.new_car_sales / cs.used_car_sales) -1)*100, 2) AS percent
FROM car_sales cs;
"
gap_percent_sales_cars_tbl <- (dbGetQuery(con, gap_percent_sales_cars))
```

```{r}
#| echo: false

datatable(gap_percent_sales_cars_tbl, options = list(pageLength = 5, scrollY = TRUE))
```

```{r}
#| echo: true
#| code-fold: true
#| fig-width: 7.5
#| fig-height: 6

gap_percent_sales_cars_tbl <- gap_percent_sales_cars_tbl|>
  mutate(year = as.Date(paste0(year, "-01-01")))

gap_sales_cars_tbl_plot <- ggplot(gap_percent_sales_cars_tbl, aes(x = year, y = delta))+
  geom_line(linewidth = 1, color = '#929497')+
  scale_x_date(date_breaks = '5 years',
              labels = scales::date_format('%Y'))+
  scale_y_continuous(labels = scales::dollar_format(),
                     breaks = seq(300000, 900000, 100000))+
  labs(
    subtitle = 'Yearly difference in dollars between sales of new \nand used cars increased between 1992 and 2006 \nwhen a decreased trend started until 2009 when \nit returned to the values from 1995. \nThen it increased again until 2019 \nwhen it started to decrease.',
    x = 'Year',
    y = 'Millions in Dollars'
    )+
  theme_minimal()+
  theme(plot.subtitle = element_text(size = 9))

percent_sales_cars_tbl_plot <- ggplot(gap_percent_sales_cars_tbl, aes(x = year, y = percent))+
  geom_line(linewidth = 1, color = '#929497')+
  scale_x_date(date_breaks = '5 years',
              labels = scales::date_format('%Y'))+
  scale_y_continuous(breaks = seq(600, 1300, 100),
                     labels = scales::percent_format(scale = 1))+
  labs(
    subtitle = 'After 1993, the percent difference between sales at \nnew cars and used cars dealers decreased (even though it \nincreased a bit in 2001) and then continued to \ndecrease until 2009 when it reached its lowest value. \nThen, the percent diffrenece increased until 2014, and \nagain decreased until 2020, returning to 2009 values.',
    x = 'Year',
    y = 'Percent'
    )+
  theme_minimal()+
  theme(plot.subtitle = element_text(size = 9))


(combine_plot <- gap_sales_cars_tbl_plot +
  plot_spacer() +
  percent_sales_cars_tbl_plot +
  plot_layout(widths = c(8, -0.0005, 8)) +
  plot_annotation(
    title = 'Yearly sales and percent difference between sales at new and used car dealers in the US',
    subtitle = '1992 to 2020'
  ))
  
```

## Conclusion

Time series analysis is a powerful way to analyze data. In these examples I used simple techniques for trending time series data such as comparing components of a trend and use percent of total calculation to compare parts to the whole.
